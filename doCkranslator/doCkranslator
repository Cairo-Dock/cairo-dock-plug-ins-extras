#!/usr/bin/python

# This is a part of the external doCkranslator applet for Cairo-Dock
#
# Author: Eduardo Mucelli Rezende Oliveira
# E-mail: edumucelli@gmail.com or eduardom@dcc.ufmg.br
#
# This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.

# This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.

# This applet provides a translator tool using the Google Translator service
#    doCkranslator translates from lots of languages to lots of languages
#    To choose the source language Right-click on the icon -> doCkranslator -> Configuration
#    To choose the destination language:
#    (I) Scroll up/down over the icon
#    (II) Right-click on the icon -> To -> Choose the destination language
#    To translate:
#    (I) Left-click on the icon; type your text and validate
#    (II) Copy the text, middle click on the icon, the text contained in the clipboard will be automatically copied into input dialog; validate
#    Translated text will be shown as a dialog and be available in the clipboard, just press Ctrl+v to have it

import gobject, glib, dbus, os.path, urllib, pygtk, gtk, ConfigParser
from dbus.mainloop.glib import DBusGMainLoop
from sgmllib import SGMLParser
from urllib import FancyURLopener
pygtk.require('2.0')

DBusGMainLoop(set_as_default=True)

class doCkranslator:
    def start(self):
        bus = dbus.SessionBus()
        applet_name = os.path.basename(os.path.abspath("."))                            # name of the applet must the same as the folder
        applet_path = "/org/cairodock/CairoDock/%s" % applet_name                       # path where our object is stored on the bus
        applet_object = bus.get_object("org.cairodock.CairoDock", applet_path)
        icon = dbus.Interface(applet_object, "org.cairodock.CairoDock.applet")
        configuration = os.path.expanduser("~/.config/cairo-dock/current_theme/plug-ins/%s/%s.conf") % (applet_name, applet_name)
        
        applet = Applet(icon, configuration)
        applet.start()

        loop = gobject.MainLoop()
        loop.run()
        sys.exit(0)

class AgentOpener(FancyURLopener):
    """Masked user-agent otherwise the access would be forbidden"""
    version = 'Mozilla/5.0 (Windows; U; Windows NT 5.1; it; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11'

class TranslatorParser(SGMLParser):
    def reset(self):                              
        SGMLParser.reset(self)
        self.translated_content = ""
        self.inside_a_element = 0

    def start_span(self, attrs):                  
        for name, value in attrs:
            if name == "id" and value == "result_box":
                self.inside_a_element = 1
    
    def end_span(self):
        self.inside_a_element = 0

    def handle_data(self, text):
        if self.inside_a_element:
            self.translated_content = text

    def parse(self, page):
        self.feed(page)
        self.close()

class Interface:
    """ Create a interface between the Applet and Parser
        This module receives, from the Applet's user, the text to be translated and
        access the parser to get the context of the Google Translator for this text"""
    def __init__(self, text_to_be_translated):
        self.text_to_be_translated = text_to_be_translated
        
    def translate_it(self, source, destiny):
        parser = TranslatorParser()                                                     # create the parser
        opener = AgentOpener()                                                          # opens the web connection with masked user-agent
        url = "http://translate.google.com/?sl=%s&tl=%s&q=%s" % (source, destiny, self.text_to_be_translated.replace(' ', '%20').encode('utf-8'))
        page = opener.open(url)                                                         # get the HTML
        parser.parse(page.read())                                                       # feed the parser to get the specific content: translated text
        page.close()                                                                    # lets close the page connection
        self.text_to_be_translated = parser.translated_content                          # from the parser, we get the translated content
        return self.text_to_be_translated

class Language:
    def __init__(self, name, abbrv):
        self.name = name
        self.abbrv = abbrv

class Applet:

    def __init__(self, icon, configuration):
        self.icon = icon
        self.configuration = configuration                                              # configuration file
        self.translated_text = ""
        self.source = None                                                              # get it from configuration file
        self.sources = []                                                               # list of possible source languages
        self.destiny = None                                                             # get it from configuration file
        self.destinies = []                                                             # list of possible resulting languages
        self.scroll_destiny_language = 0
        self.dialog_active_time = 5                                                     # time in seconds that the dialog window will be active

    def start(self):
        self.read_languages_file()
        self.set_configuration_parameters()
        self.connect_to_callbacks()

    def connect_to_callbacks(self):
        self.icon.connect_to_signal("on_click", self.action_on_click)
        self.icon.connect_to_signal("on_answer", self.action_on_answer)
        self.icon.connect_to_signal("on_build_menu", self.action_on_build_menu)
        self.icon.connect_to_signal("on_scroll", self.action_on_scroll)
        self.icon.connect_to_signal("on_menu_select", self.action_on_menu_select)
        self.icon.connect_to_signal("on_middle_click", self.action_on_middle_click)
        self.icon.connect_to_signal("on_reload_module", self.action_on_reload)

    def set_configuration_parameters(self):
        reader = ConfigParser.RawConfigParser()
        reader.read(self.configuration)
        slang = reader.getint('Configuration', 'source')                                 # get the source language position in the list
        dlang = reader.getint('Configuration', 'destiny')                                # get the destination language position in the list
        self.source = self.sources[slang]
        self.destiny = self.destinies[dlang]                                             # first set the destination language ...
        self.inform_current_destiny_language()                                           # ... and show it

    def read_languages_file(self):
        """Read the languages file formated as Name<space>Abbreviation, e.g, Portuguese pt"""
        f = open('.languages', "rb")
        for line in f:
            splited = line.split()                                                      # split the line by space token
            name, abbrv = splited[0], splited[1]
            self.sources.append(Language(name, abbrv))                                  # e.g, Language("English", "en")
            self.destinies.append(Language(name, abbrv))                                # e.g, Language("Portuguese", "pt")

    def translate(self, sentence, source, destiny):
        print "sentence: %s (from: %s to: %s)" % (sentence, source, destiny)
        self.inform_start_of_waiting_process()

        interface = Interface(sentence)
        translated = interface.translate_it(source, destiny)
        self.icon.ShowDialog(translated, self.dialog_active_time)
        self.set_to_clipboard(translated)

        self.inform_end_of_waiting_process()
        self.inform_current_destiny_language()
        print "translated: %s" % translated

    def switch_destiny_language(self, index):
        max_index = len(self.destinies) - 1
        if index < 0:
            index = 0									            					# keep the lower limit
        if index > max_index:
    		index = max_index - 1
        self.destiny = self.destinies[index]

        self.inform_current_destiny_language()

    def ask_text(self, default=""):
        label = "Translate from %s to %s:" % (self.source.name, self.destiny.name)
        self.icon.AskText(label, default)                                               # heya user, tell me what do you wanna translate

    def action_on_answer(self, answer):
        if answer:
        	self.translate(answer, self.source.abbrv, self.destiny.abbrv)               # what to be translated, the source and destination languages

    def action_on_middle_click(self):
        content = self.get_from_clipboard()
        if content:
            self.ask_text(content)

    def action_on_click(self, param):
        self.ask_text()

    def action_on_menu_select(self, selected_menu):
        self.switch_destiny_language(selected_menu)

    def action_on_scroll(self, scroll_up):
        if scroll_up:
            self.scroll_destiny_language -= 1
            self.switch_destiny_language (self.scroll_destiny_language)
        else:
            self.scroll_destiny_language += 1
            self.switch_destiny_language (self.scroll_destiny_language)

    def action_on_build_menu(self):
        destiny_sub_menu_icon = os.path.abspath("./data/to.png")
        destiny_sub_menu = [{'type':1, 'label':'To', 'menu':0, 'id':1, 'icon':destiny_sub_menu_icon}]
        index = 0
        for language in self.destinies:
            item = {}
            item['type'] = 0
            item['label'] = language.name
            item['menu'] = 1                                                            # belongs to sub-menu "To"
            item['id'] = index
            item['icon'] = destiny_sub_menu_icon
            index += 1
            destiny_sub_menu.append(item)
        try:
            self.icon.AddMenuItems(destiny_sub_menu)
        except TypeError:
            print "AddMenuItems method is not available"

    def action_on_reload(self, config_has_changed):
	    if config_has_changed:
		    self.set_configuration_parameters()

    def set_to_clipboard(self, sentence):
        clipboard = gtk.clipboard_get()                                                 # get the clipboard
        clipboard.set_text(sentence)                                                    # set the clipboard the translated text

    def get_from_clipboard(self):
        clipboard = gtk.clipboard_get()
        return clipboard.wait_for_text()

    def inform_start_of_waiting_process(self):
        self.icon.SetQuickInfo("...")

    def inform_end_of_waiting_process(self):
        self.icon.SetQuickInfo("")

    def inform_current_destiny_language(self):
        self.icon.SetQuickInfo(self.destiny.name)

if __name__ == '__main__':
    doCkranslator().start()
