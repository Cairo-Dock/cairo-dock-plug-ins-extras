#!/usr/bin/python

# This is a part of the external applets for Cairo-Dock
# Copyright : (C) 2011 by Benjamin
# E-mail : jesuisbenjamin@gmail.com
# Thanks to Matttbe, Fabounet and Eduardo for their help on this. 
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
# http://www.gnu.org/licenses/licenses.html#GPL
#
# This program depends on FBCMD, a command line interface (CLI) for Facebook.
# http://fbcmd.dtompkins.com/ 

####################
### dependancies ###
####################

from CDApplet import CDApplet
import glib
import gtk
import os
import subprocess
from subprocess import PIPE
import sys
import time

class FaceBook(CDApplet):
	def __init__(self):
		# in fbconfig is stored configuration information
		self.fbconfig = {}
		# in fb is stored data from Facebook
		self.fb = {}
		# recurence is the interval between updates in milliseconds
		self.recurence = int
		# in self.appconfig is the alarm configuration information
		self.appconfig = {}
		# self.counter hold the nubner of notifications
		self.counter = 0
		# log file where self.fbcmd and self.fbcmd values are recorded
		self.logfile = 'fbcmd'
		# whether fbcmd is installed
		self.fbcmd = bool
		# message in case fbcmd is not installed:
		self.needfbcmd = "It seems FBCMD is not installed on your computer. You need to install FBCMD for this applet to function: do you agree?"
		# whether fbcmd is authorised on Facebook
		self.fbcmdpass = bool
		# message in case fbcmd is not authorised on Facebook
		self.needpass = "It seems FBCMD has no access to Facebook. Click OK to grant FBCMD access to your account."
		self.needauth = "Now you need to get your get your authorisation code from another page (click OK) and type it in the next dialogue."
		self.needcode = "Did you get your access code? Then in the field below. Otherwise close this dialogue and try again :)"
		# type of dialog poping up "default", "install", "pass", "auth", "code"
		self.dialog_type = 0
		# how should info be displayed on the icon (quickinfo or emblem)
		self.info = "emblem"
		# data for svg emblem
		self.svg_data = str
		# commandline on click
		self.click = "x-www-browser 'http://www.facebook.com/'"
		# name of user fetched from Facebook
		self.fbusername = str
		CDApplet.__init__(self)
		
	def find_fbcmd(self):
		# this method will check whether FBCMD is already installed on the computer
		fbcmd = os.popen("ls /usr/local/bin/ | grep fbcmd").readlines()
		if fbcmd[0] == 'fbcmd\n':
			return True
		else:
			return False
		
	def install_failed(self):
		# this method calls a dialog in case installation fails
		self.icon.ShowDialog("Installation of FBCMD failed. Please proceed manually (http://fbcmd.dtompkins.com)",8)
		sys.exit()
		
	def install_fbcmd(self):
		# this method installs fbcmd
		# first it retrieves the installation file
		retreive = subprocess.call(["curl -O https://github.com/dtompkins/fbcmd/raw/master/fbcmd_update.php"], shell=True)
		# if the download went well it carries on
		if retreive == 0:
			self.icon.ShowDialog("FBCMD update completed, please wait while installing...",3)
			time.sleep(3)
		else:
			self.install_failed()
		# then it grants permission to the file to operate
		update = subprocess.call(["gksudo php fbcmd_update.php sudo"], shell=True)
		# if successful, it continues
		if update == 0:
			self.icon.ShowDialog("Please wait while FBCMD is installing...",5)
		else:
			self.install_failed()
		# finally it installs fbcmd
		installed = subprocess.call(["gksudo php fbcmd_update.php install"], shell=True)
		# if successful it can return
		if installed == 0:
			self.icon.ShowDialog("Hurray! FBCMD's installed!",3)
			self.fbcmd == True
			# dialog_type == will tell fbcmd_steps() it can proceed
			self.dialog_type = 2
		else:
			self.install_failed()
			
	def access_failed(self):
		# in case the procedure of granting fbcmd access to Facebook fails
		# a dialog pops up and the applet quits
		self.icon.ShowDialog("Failed to get access to Facebook. Please proceed manually from command line 'fbcmd auth ******'",8)
		sys.exit()
		
	def access_fbcmd(self, code):
		# this method is taking care of validating the Facebook authorisation code
		# so that fbcmd can work offline
		access = subprocess.call(["fbcmd auth %s" % code])
		if access == 0:
			# double checking:
			self.fbcmdpass = self.check_access() 
			if self.fbcmdpass == True:
				greeting = "Alright", fbusername, "we're connected to Facebook. Let's rock! :)"
				self.icon.ShowDialog(greeting, 3)
				#WRITE FBCMDPASS=true in .conf file!!
				# self.dialog_type = 5 tells fbcmd_steps() it can proceed
				self.dialog_type = 5
			else:
				self.access_failed()
		else:
			self.access_failed()
			
	def fbcmd_steps(self):
		# this method acts as a semaphore to throw dialogs according
		# to the steps achieved in the process of granting access to
		# fbcmd on Facebook. It is initated by self.check_again() which
		# will repeat fbcmd_steps() every two seconds as long the
		# self.dialog_type == 0 and until it reaches the value of 5.
		if self.dialog_type == 1:
			self.icon.PopupDialog({"message" : self.needfbcmd, "buttons" : "ok;cancel"},{})
			self.dialog_type = 11
			return True
		if self.dialog_type == 2:
			self.icon.PopupDialog({"message" : self.needpass, "buttons" : "ok;cancel"},{})
			self.dialog_type = 22
			return True
		elif self.dialog_type == 3:
			self.icon.PopupDialog({"message" : self.needauth, "buttons" : "ok;cancel"},{})
			self.dialog_type = 33
			return True
		elif self.dialog_type == 4:
			time.sleep(6)
			self.icon.PopupDialog({"message" : self.needcode, "buttons" : "ok;cancel"},
			{"widget-type" : "text-entry", "initial value" : "Enter Authorisation Code"})
			self.dialog_type = 44
			return True
		elif self.dialog_type == 5:
			# step 5 consists in recording a log of installation and access
			# then it can start running the applet and repeat
			self.writetolog()
			# Now it can do it's business
			self.update()
			self.repeat()
			# we need to end check_again()
			return False
		else:
			return True
		
	def check_access(self):
		# this method checks if fbcmd has access to facebook
		# it's done by checking the facebook username
		# an opportunity to use it too :)
		data = subprocess.Popen(['fbcmd', 'whoami'], stdout=PIPE).stdout
		data = data.read()
		if len(data) > 0:
			data = data.split()
			self.fbusername  = data[1]
			return True
		else:
			return False
		
	def writetolog(self):
		# in case the app has to look for installation and authorisation
		# this method records it in a log file so it doesn't have to look
		# for it again in the future
		loglist = ['FBCMD', str(self.fbcmd), 'FBCMDPASS', str(self.fbcmdpass)]
		logstring = ' '.join(loglist)
		destination = open(self.logfile, 'w')
		destination.write(logstring)
		destination.close()
		
	def str2bool(self, string):
		# method to convert string to boolean
		return string in ('True')
		
	def get_config(self, keyfile):
		# this is a function inherited from the CDApplet class
		# it will run automatically as the CDApplet instance is initated
		# the keyfiles is the .conf file in the applet's folder
		# check whether the applet has ever seen fbcmd installed
		# and whether it had access to Facebook
		try:
			# this checks whether there is any info in the log file
			log = open(self.logfile, 'r')
			loglist = log.read().split()
			self.fbcmd = self.str2bool(loglist[1])
			self.fbcmdpass = self.str2bool(loglist[-1])
		except:
			#otherwise we set the values to False
			self.fbcmd = False
			self.fbcmdpass = False
		# it checks which notifications the user wants
		# and it appends them to the self.fbconfig dictionary
		self.fbconfig['MESSAGES_UNREAD'] 	= keyfile.getboolean('Configuration', 'MESSAGES_UNREAD')
		self.fbconfig['POKES'] 				= keyfile.getboolean('Configuration', 'POKES')
		self.fbconfig['SHARES_UNREAD'] 		= keyfile.getboolean('Configuration', 'SHARES_UNREAD')
		self.fbconfig['FRIEND_REQUESTS'] 	= keyfile.getboolean('Configuration', 'FRIEND_REQUESTS')
		self.fbconfig['GROUP_INVITES'] 		= keyfile.getboolean('Configuration', 'GROUP_INVITES')
		self.fbconfig['EVENT_INVITES'] 		= keyfile.getboolean('Configuration', 'EVENT_INVITES')
		self.fbconfig['NOTICES_UNREAD']		= keyfile.getboolean('Configuration', 'NOTICES_UNREAD')
		# then it checks when and how the user wants to be informed
		# and it appends that to the self.appconfig dictionary
		self.appconfig['ATTENTION_WHEN']		= keyfile.get('Configuration', 'ATTENTION_WHEN')
		self.appconfig['ATTENTION_HOW']			= keyfile.get('Configuration', 'ATTENTION_HOW')
		self.appconfig['ATTENTION_DIA']			= keyfile.getboolean('Configuration', 'ATTENTION_DIA')
		self.appconfig['ATTENTION_SOUND']		= keyfile.getboolean('Configuration', 'ATTENTION_SOUND')
		# then it fetches the update interval requested by user in minutes
		# converts it in milliseconds as self.recurence
		r = keyfile.getint('Configuration', 'UPDATE')
		# interval must be at least a minute
		if r < 1:
			self.recurence = 60000
		else:
			self.recurence = r * 60000
		# finally it checks the user's choice in appearance: emblem or quickinfo
		self.info = keyfile.get('Configuration', 'INFO')
		
	def set_quick_info(self):
		# this method places a quick info displaying the counter
		# if the counter is different from 0
		# depending on the configuration, it displays either a quickinfo or an svg emblem
		if self.info == "quickinfo":
			if self.counter == 0:
				self.icon.SetQuickInfo(format(""))
			else:
				self.icon.SetQuickInfo(format(self.counter))
		else:
			if self.counter == 0:
				# rest icon
				self.icon.SetIcon("~/.config/cairo-dock/third-party/Facebook/icon")
				pass
			else:
				# write svg emblem
				# data for svg emblem
				self.svg_data = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<!-- Created with Inkscape (http://www.inkscape.org/) -->\n\n<svg\n   xmlns:dc="http://purl.org/dc/elements/1.1/"\n   xmlns:cc="http://creativecommons.org/ns#"\n   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"\n   xmlns:svg="http://www.w3.org/2000/svg"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:xlink="http://www.w3.org/1999/xlink"\n   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"\n   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"\n   version="1.0"\n   width="39.983284"\n   height="39.945618"\n   id="svg2408"\n   inkscape:version="0.48.0 r9654"\n   sodipodi:docname="emblem.svg">\n  <sodipodi:namedview\n     pagecolor="#ffffff"\n     bordercolor="#666666"\n     borderopacity="1"\n     objecttolerance="10"\n     gridtolerance="10"\n     guidetolerance="10"\n     inkscape:pageopacity="0"\n     inkscape:pageshadow="2"\n     inkscape:window-width="1280"\n     inkscape:window-height="748"\n     id="namedview94"\n     showgrid="false"\n     inkscape:zoom="3.4546968"\n     inkscape:cx="-27.204217"\n     inkscape:cy="-10.241983"\n     inkscape:window-x="0"\n     inkscape:window-y="0"\n     inkscape:window-maximized="1"\n     inkscape:current-layer="layer4"\n     fit-margin-top="0"\n     fit-margin-left="0"\n     fit-margin-right="0"\n     fit-margin-bottom="0"\n     inkscape:snap-bbox="true"\n     inkscape:snap-page="true" />\n  <defs\n     id="defs2410">\n    <linearGradient\n       id="linearGradient3942">\n      <stop\n         id="stop3944"\n         style="stop-color:#ffffff;stop-opacity:1"\n         offset="0" />\n      <stop\n         id="stop3946"\n         style="stop-color:#ffffff;stop-opacity:0"\n         offset="1" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient3727">\n      <stop\n         id="stop3729"\n         style="stop-color:#d5d5d5;stop-opacity:1"\n         offset="0" />\n      <stop\n         id="stop3731"\n         style="stop-color:#f1f1f1;stop-opacity:1"\n         offset="1" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient3641">\n      <stop\n         id="stop3643"\n         style="stop-color:#000000;stop-opacity:1"\n         offset="0" />\n      <stop\n         id="stop3645"\n         style="stop-color:#000000;stop-opacity:0"\n         offset="1" />\n    </linearGradient>\n    <linearGradient\n       x1="45.447727"\n       y1="92.539597"\n       x2="45.447727"\n       y2="7.0165396"\n       id="ButtonShadow"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="scale(1.0058652,0.994169)">\n      <stop\n         id="stop3750"\n         style="stop-color:#000000;stop-opacity:1"\n         offset="0" />\n      <stop\n         id="stop3752"\n         style="stop-color:#000000;stop-opacity:0.58823532"\n         offset="1" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient3737">\n      <stop\n         id="stop3739"\n         style="stop-color:#ffffff;stop-opacity:1"\n         offset="0" />\n      <stop\n         id="stop3741"\n         style="stop-color:#ffffff;stop-opacity:0"\n         offset="1" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient3700">\n      <stop\n         id="stop3702"\n         style="stop-color:#dcdcdc;stop-opacity:1"\n         offset="0" />\n      <stop\n         id="stop3704"\n         style="stop-color:#f0f0f0;stop-opacity:1"\n         offset="1" />\n    </linearGradient>\n    <filter\n       color-interpolation-filters="sRGB"\n       id="filter3174">\n      <feGaussianBlur\n         id="feGaussianBlur3176"\n         stdDeviation="1.71" />\n    </filter>\n    <filter\n       x="-0.192"\n       y="-0.192"\n       width="1.3839999"\n       height="1.3839999"\n       color-interpolation-filters="sRGB"\n       id="filter3794">\n      <feGaussianBlur\n         id="feGaussianBlur3796"\n         stdDeviation="5.28" />\n    </filter>\n    <linearGradient\n       x1="48"\n       y1="20.220806"\n       x2="48"\n       y2="138.66119"\n       id="linearGradient3613"\n       xlink:href="#linearGradient3737"\n       gradientUnits="userSpaceOnUse" />\n    <radialGradient\n       cx="48"\n       cy="90.171875"\n       r="42"\n       fx="48"\n       fy="90.171875"\n       id="radialGradient3619"\n       xlink:href="#linearGradient3737"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="matrix(1.1573129,0,0,0.99590774,-7.5510206,0.19713193)" />\n    <clipPath\n       id="clipPath3613">\n      <rect\n         width="84"\n         height="84"\n         rx="6"\n         ry="6"\n         x="6"\n         y="6"\n         id="rect3615"\n         style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none" />\n    </clipPath>\n    <linearGradient\n       x1="48"\n       y1="88"\n       x2="48"\n       y2="32"\n       id="linearGradient3627"\n       xlink:href="#linearGradient3700"\n       gradientUnits="userSpaceOnUse" />\n    <linearGradient\n       x1="48"\n       y1="88"\n       x2="48"\n       y2="36"\n       id="linearGradient3635"\n       xlink:href="#linearGradient3727"\n       gradientUnits="userSpaceOnUse" />\n    <filter\n       color-interpolation-filters="sRGB"\n       id="filter3649">\n      <feGaussianBlur\n         id="feGaussianBlur3651"\n         stdDeviation="1.38" />\n    </filter>\n    <filter\n       color-interpolation-filters="sRGB"\n       id="filter3665">\n      <feGaussianBlur\n         id="feGaussianBlur3667"\n         stdDeviation="0.69" />\n    </filter>\n    <linearGradient\n       x1="36.357143"\n       y1="6"\n       x2="36.357143"\n       y2="63.893143"\n       id="linearGradient3687"\n       xlink:href="#linearGradient3737"\n       gradientUnits="userSpaceOnUse" />\n    <linearGradient\n       x1="48"\n       y1="90"\n       x2="48"\n       y2="5.9877172"\n       id="linearGradient3689"\n       xlink:href="#linearGradient3700"\n       gradientUnits="userSpaceOnUse" />\n    <clipPath\n       id="clipPath3696">\n      <rect\n         width="84"\n         height="84"\n         rx="6"\n         ry="6"\n         x="106"\n         y="6"\n         id="rect3698"\n         style="fill:#ff00ff;fill-opacity:1;fill-rule:nonzero;stroke:none" />\n    </clipPath>\n    <linearGradient\n       x1="48"\n       y1="32"\n       x2="48"\n       y2="80"\n       id="linearGradient3701"\n       xlink:href="#linearGradient3641"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="translate(100,0)" />\n    <clipPath\n       id="clipPath3703">\n      <rect\n         width="84"\n         height="84"\n         rx="6"\n         ry="6"\n         x="106"\n         y="6"\n         id="rect3705"\n         style="fill:#ff00ff;fill-opacity:1;fill-rule:nonzero;stroke:none" />\n    </clipPath>\n    <linearGradient\n       x1="51"\n       y1="62"\n       x2="51"\n       y2="21"\n       id="linearGradient3707"\n       xlink:href="#linearGradient3641"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="translate(100,-1)" />\n    <linearGradient\n       id="linearGradient3737-3">\n      <stop\n         id="stop3739-5"\n         style="stop-color:#ffffff;stop-opacity:1"\n         offset="0" />\n      <stop\n         id="stop3741-7"\n         style="stop-color:#ffffff;stop-opacity:0"\n         offset="1" />\n    </linearGradient>\n    <radialGradient\n       cx="48"\n       cy="90.171875"\n       r="42"\n       fx="48"\n       fy="90.171875"\n       id="radialGradient2858"\n       xlink:href="#linearGradient3737-3"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="matrix(1.1573129,0,0,0.99590774,-7.551021,0.1971319)" />\n    <linearGradient\n       x1="45.447727"\n       y1="92.539597"\n       x2="45.447727"\n       y2="7.0165396"\n       id="ButtonShadow-0"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="matrix(1.0058652,0,0,0.994169,100,0)">\n      <stop\n         id="stop3750-8"\n         style="stop-color:#000000;stop-opacity:1"\n         offset="0" />\n      <stop\n         id="stop3752-5"\n         style="stop-color:#000000;stop-opacity:0.58823532"\n         offset="1" />\n    </linearGradient>\n    <linearGradient\n       x1="32.251034"\n       y1="6.1317081"\n       x2="32.251034"\n       y2="90.238609"\n       id="linearGradient3780"\n       xlink:href="#ButtonShadow-0"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="matrix(1.0238095,0,0,1.0119048,-1.1428571,-98.071429)" />\n    <linearGradient\n       x1="32.251034"\n       y1="6.1317081"\n       x2="32.251034"\n       y2="90.238609"\n       id="linearGradient3772"\n       xlink:href="#ButtonShadow-0"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="matrix(1.0238095,0,0,1.0119048,-1.1428571,-98.071429)" />\n    <linearGradient\n       x1="32.251034"\n       y1="6.1317081"\n       x2="32.251034"\n       y2="90.238609"\n       id="linearGradient3725"\n       xlink:href="#ButtonShadow-0"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="matrix(1.0238095,0,0,1.0119048,-1.1428571,-98.071429)" />\n    <linearGradient\n       x1="32.251034"\n       y1="6.1317081"\n       x2="32.251034"\n       y2="90.238609"\n       id="linearGradient3721"\n       xlink:href="#ButtonShadow-0"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="translate(0,-97)" />\n    <linearGradient\n       x1="32.251034"\n       y1="6.1317081"\n       x2="32.251034"\n       y2="90.238609"\n       id="linearGradient2918"\n       xlink:href="#ButtonShadow-0"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="matrix(1.0238095,0,0,1.0119048,-1.1428571,-98.071429)" />\n    <linearGradient\n       id="linearGradient3801">\n      <stop\n         id="stop3803"\n         style="stop-color:#a4d620;stop-opacity:1"\n         offset="0" />\n      <stop\n         id="stop3805"\n         style="stop-color:#62a915;stop-opacity:1"\n         offset="1" />\n    </linearGradient>\n    <linearGradient\n       x1="45.298355"\n       y1="72.618279"\n       x2="79.622185"\n       y2="72.618279"\n       id="linearGradient3915"\n       xlink:href="#linearGradient3801"\n       gradientUnits="userSpaceOnUse" />\n    <linearGradient\n       x1="68"\n       y1="52"\n       x2="68"\n       y2="84"\n       id="linearGradient3948"\n       xlink:href="#linearGradient3942"\n       gradientUnits="userSpaceOnUse" />\n    <linearGradient\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3942-7"\n       id="linearGradient3948-1"\n       y2="84"\n       x2="68"\n       y1="52"\n       x1="68" />\n    <linearGradient\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3801-9"\n       id="linearGradient3915-7"\n       y2="72.618279"\n       x2="79.622185"\n       y1="72.618279"\n       x1="45.298355" />\n    <linearGradient\n       id="linearGradient3801-9">\n      <stop\n         offset="0"\n         style="stop-color:#a4d620;stop-opacity:1"\n         id="stop3803-1" />\n      <stop\n         offset="1"\n         style="stop-color:#62a915;stop-opacity:1"\n         id="stop3805-7" />\n    </linearGradient>\n    <linearGradient\n       gradientTransform="matrix(1.0238095,0,0,1.0119048,-1.1428571,-98.071429)"\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#ButtonShadow-0-0"\n       id="linearGradient2918-0"\n       y2="90.238609"\n       x2="32.251034"\n       y1="6.1317081"\n       x1="32.251034" />\n    <linearGradient\n       gradientTransform="translate(0,-97)"\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#ButtonShadow-0-0"\n       id="linearGradient3721-9"\n       y2="90.238609"\n       x2="32.251034"\n       y1="6.1317081"\n       x1="32.251034" />\n    <linearGradient\n       gradientTransform="matrix(1.0238095,0,0,1.0119048,-1.1428571,-98.071429)"\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#ButtonShadow-0-0"\n       id="linearGradient3725-4"\n       y2="90.238609"\n       x2="32.251034"\n       y1="6.1317081"\n       x1="32.251034" />\n    <linearGradient\n       gradientTransform="matrix(1.0238095,0,0,1.0119048,-1.1428571,-98.071429)"\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#ButtonShadow-0-0"\n       id="linearGradient3772-9"\n       y2="90.238609"\n       x2="32.251034"\n       y1="6.1317081"\n       x1="32.251034" />\n    <linearGradient\n       gradientTransform="matrix(1.0238095,0,0,1.0119048,-1.1428571,-98.071429)"\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#ButtonShadow-0-0"\n       id="linearGradient3780-5"\n       y2="90.238609"\n       x2="32.251034"\n       y1="6.1317081"\n       x1="32.251034" />\n    <linearGradient\n       gradientTransform="matrix(1.0058652,0,0,0.994169,100,0)"\n       gradientUnits="userSpaceOnUse"\n       id="ButtonShadow-0-0"\n       y2="7.0165396"\n       x2="45.447727"\n       y1="92.539597"\n       x1="45.447727">\n      <stop\n         offset="0"\n         style="stop-color:#000000;stop-opacity:1"\n         id="stop3750-8-6" />\n      <stop\n         offset="1"\n         style="stop-color:#000000;stop-opacity:0.58823532"\n         id="stop3752-5-1" />\n    </linearGradient>\n    <radialGradient\n       gradientTransform="matrix(1.1573129,0,0,0.99590774,-7.551021,0.1971319)"\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3737-3-2"\n       id="radialGradient2858-1"\n       fy="90.171875"\n       fx="48"\n       r="42"\n       cy="90.171875"\n       cx="48" />\n    <linearGradient\n       id="linearGradient3737-3-2">\n      <stop\n         offset="0"\n         style="stop-color:#ffffff;stop-opacity:1"\n         id="stop3739-5-2" />\n      <stop\n         offset="1"\n         style="stop-color:#ffffff;stop-opacity:0"\n         id="stop3741-7-6" />\n    </linearGradient>\n    <linearGradient\n       gradientTransform="translate(100,-1)"\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3641-7"\n       id="linearGradient3707-7"\n       y2="21"\n       x2="51"\n       y1="62"\n       x1="51" />\n    <clipPath\n       id="clipPath3703-7">\n      <rect\n         style="fill:#ff00ff;fill-opacity:1;fill-rule:nonzero;stroke:none"\n         id="rect3705-2"\n         y="6"\n         x="106"\n         ry="6"\n         rx="6"\n         height="84"\n         width="84" />\n    </clipPath>\n    <linearGradient\n       gradientTransform="translate(100,0)"\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3641-7"\n       id="linearGradient3701-1"\n       y2="80"\n       x2="48"\n       y1="32"\n       x1="48" />\n    <clipPath\n       id="clipPath3696-8">\n      <rect\n         style="fill:#ff00ff;fill-opacity:1;fill-rule:nonzero;stroke:none"\n         id="rect3698-7"\n         y="6"\n         x="106"\n         ry="6"\n         rx="6"\n         height="84"\n         width="84" />\n    </clipPath>\n    <linearGradient\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3700-8"\n       id="linearGradient3689-4"\n       y2="5.9877172"\n       x2="48"\n       y1="90"\n       x1="48" />\n    <linearGradient\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3737-8"\n       id="linearGradient3687-0"\n       y2="63.893143"\n       x2="36.357143"\n       y1="6"\n       x1="36.357143" />\n    <filter\n       id="filter3665-9"\n       color-interpolation-filters="sRGB">\n      <feGaussianBlur\n         stdDeviation="0.69"\n         id="feGaussianBlur3667-5" />\n    </filter>\n    <filter\n       id="filter3649-6"\n       color-interpolation-filters="sRGB">\n      <feGaussianBlur\n         stdDeviation="1.38"\n         id="feGaussianBlur3651-4" />\n    </filter>\n    <linearGradient\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3727-2"\n       id="linearGradient3635-6"\n       y2="36"\n       x2="48"\n       y1="88"\n       x1="48" />\n    <linearGradient\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3700-8"\n       id="linearGradient3627-2"\n       y2="32"\n       x2="48"\n       y1="88"\n       x1="48" />\n    <clipPath\n       id="clipPath3613-8">\n      <rect\n         style="fill:#ffffff;fill-opacity:1;fill-rule:nonzero;stroke:none"\n         id="rect3615-9"\n         y="6"\n         x="6"\n         ry="6"\n         rx="6"\n         height="84"\n         width="84" />\n    </clipPath>\n    <radialGradient\n       gradientTransform="matrix(1.1573129,0,0,0.99590774,-7.5510206,0.19713193)"\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3737-8"\n       id="radialGradient3619-6"\n       fy="90.171875"\n       fx="48"\n       r="42"\n       cy="90.171875"\n       cx="48" />\n    <linearGradient\n       gradientUnits="userSpaceOnUse"\n       xlink:href="#linearGradient3737-8"\n       id="linearGradient3613-0"\n       y2="138.66119"\n       x2="48"\n       y1="20.220806"\n       x1="48" />\n    <filter\n       id="filter3794-9"\n       color-interpolation-filters="sRGB"\n       height="1.3839999"\n       width="1.3839999"\n       y="-0.192"\n       x="-0.192">\n      <feGaussianBlur\n         stdDeviation="5.28"\n         id="feGaussianBlur3796-2" />\n    </filter>\n    <filter\n       id="filter3174-1"\n       color-interpolation-filters="sRGB">\n      <feGaussianBlur\n         stdDeviation="1.71"\n         id="feGaussianBlur3176-4" />\n    </filter>\n    <linearGradient\n       id="linearGradient3700-8">\n      <stop\n         offset="0"\n         style="stop-color:#dcdcdc;stop-opacity:1"\n         id="stop3702-4" />\n      <stop\n         offset="1"\n         style="stop-color:#f0f0f0;stop-opacity:1"\n         id="stop3704-3" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient3737-8">\n      <stop\n         offset="0"\n         style="stop-color:#ffffff;stop-opacity:1"\n         id="stop3739-6" />\n      <stop\n         offset="1"\n         style="stop-color:#ffffff;stop-opacity:0"\n         id="stop3741-8" />\n    </linearGradient>\n    <linearGradient\n       gradientTransform="scale(1.0058652,0.994169)"\n       gradientUnits="userSpaceOnUse"\n       id="ButtonShadow-3"\n       y2="7.0165396"\n       x2="45.447727"\n       y1="92.539597"\n       x1="45.447727">\n      <stop\n         offset="0"\n         style="stop-color:#000000;stop-opacity:1"\n         id="stop3750-0" />\n      <stop\n         offset="1"\n         style="stop-color:#000000;stop-opacity:0.58823532"\n         id="stop3752-7" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient3641-7">\n      <stop\n         offset="0"\n         style="stop-color:#000000;stop-opacity:1"\n         id="stop3643-4" />\n      <stop\n         offset="1"\n         style="stop-color:#000000;stop-opacity:0"\n         id="stop3645-4" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient3727-2">\n      <stop\n         offset="0"\n         style="stop-color:#d5d5d5;stop-opacity:1"\n         id="stop3729-5" />\n      <stop\n         offset="1"\n         style="stop-color:#f1f1f1;stop-opacity:1"\n         id="stop3731-4" />\n    </linearGradient>\n    <linearGradient\n       id="linearGradient3942-7">\n      <stop\n         offset="0"\n         style="stop-color:#ffffff;stop-opacity:1"\n         id="stop3944-4" />\n      <stop\n         offset="1"\n         style="stop-color:#ffffff;stop-opacity:0"\n         id="stop3946-5" />\n    </linearGradient>\n    <linearGradient\n       inkscape:collect="always"\n       xlink:href="#ButtonShadow-3"\n       id="linearGradient3250"\n       gradientUnits="userSpaceOnUse"\n       gradientTransform="scale(1.0058652,0.994169)"\n       x1="45.447727"\n       y1="92.539597"\n       x2="45.447727"\n       y2="7.0165396" />\n    <linearGradient\n       inkscape:collect="always"\n       xlink:href="#linearGradient3801-9"\n       id="linearGradient3252"\n       gradientUnits="userSpaceOnUse"\n       x1="45.298355"\n       y1="72.618279"\n       x2="79.622185"\n       y2="72.618279" />\n    <linearGradient\n       inkscape:collect="always"\n       xlink:href="#linearGradient3942-7"\n       id="linearGradient3254"\n       gradientUnits="userSpaceOnUse"\n       x1="68"\n       y1="52"\n       x2="68"\n       y2="84" />\n  </defs>\n  <metadata\n     id="metadata2413">\n    <rdf:RDF>\n      <cc:Work\n         rdf:about="">\n        <dc:format>image/svg+xml</dc:format>\n        <dc:type\n           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />\n        <dc:title />\n      </cc:Work>\n    </rdf:RDF>\n  </metadata>\n  <g\n     id="layer2"\n     style="display:none"\n     transform="translate(-176.03343,-51.028478)">\n    <rect\n       width="86"\n       height="85"\n       rx="6"\n       ry="6"\n       x="5"\n       y="7"\n       id="rect3745"\n       style="opacity:0.9;fill:url(#ButtonShadow);fill-opacity:1;fill-rule:nonzero;stroke:none;filter:url(#filter3174)" />\n  </g>\n  <g\n     id="layer4"\n     transform="translate(-50.007625,-51.028478)">\n    <g\n       id="g3234"\n       transform="matrix(0.68115941,0,0,0.68115941,28.692755,16.26995)">\n      <path\n         style="opacity:0.1;color:#000000;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:2;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate"\n         id="path3960"\n         inkscape:connector-curvature="0"\n         d="m 89.986349,69.238985 c -0.21488,-1.561093 -1.973583,-1.971086 -3.08095,-2.785965 0.452305,-1.002477 1.307299,-1.880744 1.442147,-2.982622 0.09844,-1.212445 -1.013508,-2.114893 -2.161243,-2.135756 -0.574938,-0.191984 -1.529962,-0.121132 -1.883184,-0.466436 0.105461,-1.303923 0.927598,-2.804937 -0.05258,-3.95302 -0.907896,-1.060888 -2.339545,-0.509432 -3.503632,-0.325674 -0.950635,0.504422 -0.81239,-0.565783 -0.973216,-1.2035 -0.130627,-1.071533 -0.401383,-2.422333 -1.652276,-2.666162 -1.269606,-0.351715 -2.257329,0.785416 -3.345553,1.248885 -0.564682,0.197811 -0.761585,-1.032508 -1.178359,-1.409042 -0.426005,-1.011804 -1.521655,-1.848863 -2.654045,-1.413094 -1.095119,0.436651 -1.63445,1.627605 -2.458205,2.425428 -0.973647,-0.65486 -1.72467,-1.7847 -2.91707,-1.99934 -1.243767,-0.181639 -2.134633,0.905175 -2.372989,2.019516 -0.345055,0.444832 -0.243497,1.842522 -1.003052,1.403006 -1.213096,-0.355405 -2.631658,-1.302577 -3.801916,-0.341572 -1.164288,0.944179 -0.641361,2.603822 -0.785903,3.912444 -1.186176,0.269467 -2.880347,-0.340038 -3.868298,0.741757 -1.026659,1.143887 -0.143349,2.597452 0.237559,3.813095 0.487992,0.76899 -0.891072,0.672735 -1.319748,1.016916 -1.098052,0.268634 -2.195073,1.121664 -2.064313,2.380723 0.249354,1.192288 1.335753,1.97237 1.99934,2.949845 -0.871859,0.915157 -2.269562,1.493314 -2.556533,2.818742 -0.186067,1.142981 0.709312,1.986005 1.663193,2.403037 0.374257,0.418594 1.762649,0.565214 1.196802,1.235928 -0.585967,1.153839 -1.765734,2.450576 -0.926208,3.768425 0.810341,1.207354 2.476744,0.956157 3.736472,1.311043 -0.08576,1.227497 -0.781478,2.521328 -0.229433,3.703695 0.526899,1.071756 1.844115,1.213477 2.87647,0.879241 0.560732,0.07218 1.729076,-0.722239 1.724808,0.155757 0.28962,1.207178 0.140911,2.908592 1.527846,3.422546 1.38487,0.596205 2.576146,-0.697698 3.773565,-1.225564 0.454783,0.276534 0.742145,1.177337 1.132089,1.695641 0.455828,1.285443 2.259105,1.820804 3.255585,0.80819 0.610876,-0.645848 1.17573,-1.360459 1.769908,-2.032116 1.070537,0.696774 1.92142,2.036743 3.310382,1.999339 1.284689,-0.0939 1.81764,-1.335721 2.151522,-2.404812 0.206115,-0.763429 0.45194,-1.441171 1.291319,-0.838121 1.079697,0.400421 2.40691,1.016712 3.407356,0.09643 1.036768,-1.007403 0.54752,-2.574581 0.688297,-3.867575 1.24572,-0.135375 2.670869,0.29881 3.736472,-0.524417 0.936001,-0.804307 0.694064,-2.129136 0.219537,-3.122161 -0.129526,-0.619425 -0.912001,-1.544893 0.15361,-1.604149 1.111548,-0.448238 2.718145,-0.69704 2.904459,-2.123887 0.293747,-1.438242 -1.158981,-2.317711 -1.863365,-3.381883 -0.0012,-0.497479 0.978512,-0.910082 1.354831,-1.374896 0.68176,-0.486375 1.154931,-1.160958 1.098503,-2.027866 z" />\n      <path\n         inkscape:connector-curvature="0"\n         style="opacity:0.15;color:#000000;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:2;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate"\n         id="path3956"\n         transform="matrix(0,1.048834,-1.048834,0,146.16452,5.4895435)"\n         d="m 60.9375,54.59375 a 0.86264402,0.86264402 0 0 0 -0.71875,0.4375 L 58.5,57.875 55.625,56.25 a 0.86264402,0.86264402 0 0 0 -1.28125,0.59375 l -0.625,3.3125 -3.28125,-0.5625 a 0.86264402,0.86264402 0 0 0 -1,1 L 50,63.875 46.6875,64.5 a 0.86264402,0.86264402 0 0 0 -0.59375,1.28125 l 1.625,2.875 L 44.875,70.375 A 0.86264402,0.86264402 0 0 0 44.75,71.78125 L 47.25,73.9375 45.15625,76.5 A 0.86264402,0.86264402 0 0 0 45.5,77.875 l 3.15625,1.1875 -1.125,3.15625 a 0.86264402,0.86264402 0 0 0 0.8125,1.15625 l 3.3125,0.03125 0.0625,3.3125 a 0.86264402,0.86264402 0 0 0 1.15625,0.8125 L 56,86.4375 l 1.1875,3.125 a 0.86264402,0.86264402 0 0 0 1.34375,0.34375 l 2.59375,-2.125 2.1875,2.5625 a 0.86264402,0.86264402 0 0 0 1.40625,-0.125 l 1.6875,-2.875 2.9375,1.625 a 0.86264402,0.86264402 0 0 0 1.25,-0.59375 l 0.59375,-3.28125 3.3125,0.5625 a 0.86264402,0.86264402 0 0 0 1,-1 L 74.9375,81.34375 78.21875,80.75 A 0.86264402,0.86264402 0 0 0 78.8125,79.5 l -1.625,-2.9375 2.875,-1.6875 a 0.86264402,0.86264402 0 0 0 0.125,-1.40625 L 77.625,71.28125 79.75,68.6875 a 0.86264402,0.86264402 0 0 0 -0.34375,-1.34375 l -3.125,-1.1875 1.09375,-3.125 A 0.86264402,0.86264402 0 0 0 76.5625,61.875 L 73.25,61.8125 73.21875,58.5 A 0.86264402,0.86264402 0 0 0 72.0625,57.6875 l -3.15625,1.125 -1.1875,-3.15625 a 0.86264402,0.86264402 0 0 0 -1.375,-0.34375 l -2.5625,2.09375 -2.15625,-2.5 a 0.86264402,0.86264402 0 0 0 -0.6875,-0.3125 z" />\n      <path\n         inkscape:connector-curvature="0"\n         style="opacity:0.3;color:#000000;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:2;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate"\n         id="path3950"\n         transform="matrix(0,1.048834,-1.048834,0,146.16452,5.4895435)"\n         d="m 74.641931,84.79994 -4.128425,-0.680449 -0.772592,4.112178 -3.646724,-2.051417 -2.132447,3.599941 -2.725174,-3.174954 -3.235096,2.653498 -1.474928,-3.915545 -3.947546,1.387004 -0.04678,-4.183864 -4.183864,-0.04678 1.387005,-3.947547 -3.915546,-1.474927 2.653499,-3.235097 -3.174955,-2.725173 3.599941,-2.132447 -2.051417,-3.646724 4.112178,-0.772592 -0.680448,-4.128426 4.128425,0.680449 0.772592,-4.112178 3.646724,2.051417 2.132447,-3.599941 2.725173,3.174954 3.235097,-2.653498 1.474927,3.915545 3.947547,-1.387004 0.04678,4.183864 4.183863,0.04678 -1.387004,3.947547 3.915545,1.474927 -2.653498,3.235097 3.174955,2.725173 -3.599942,2.132447 2.051418,3.646724 -4.112178,0.772592 z" />\n      <path\n         transform="matrix(0,1.048834,-1.048834,0,146.16452,4.4895435)"\n         inkscape:connector-curvature="0"\n         style="color:#000000;fill:#ff0000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:2;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate"\n         id="path3139"\n         d="m 74.641931,84.79994 -4.128425,-0.680449 -0.772592,4.112178 -3.646724,-2.051417 -2.132447,3.599941 -2.725174,-3.174954 -3.235096,2.653498 -1.474928,-3.915545 -3.947546,1.387004 -0.04678,-4.183864 -4.183864,-0.04678 1.387005,-3.947547 -3.915546,-1.474927 2.653499,-3.235097 -3.174955,-2.725173 3.599941,-2.132447 -2.051417,-3.646724 4.112178,-0.772592 -0.680448,-4.128426 4.128425,0.680449 0.772592,-4.112178 3.646724,2.051417 2.132447,-3.599941 2.725173,3.174954 3.235097,-2.653498 1.474927,3.915545 3.947547,-1.387004 0.04678,4.183864 4.183863,0.04678 -1.387004,3.947547 3.915545,1.474927 -2.653498,3.235097 3.174955,2.725173 -3.599942,2.132447 2.051418,3.646724 -4.112178,0.772592 z" />\n      <text\n         xml:space="preserve"\n         style="font-size:16px;font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;text-align:start;line-height:125%;letter-spacing:-1.32000005px;writing-mode:lr-tb;text-anchor:start;opacity:0.15;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;font-family:Sans;-inkscape-font-specification:Sans Bold"\n         x="59.530632"\n         y="77.325226"\n         id="text3856"\n         sodipodi:linespacing="125%"\n         transform="scale(0.9999961,1.0000039)"><tspan\n           sodipodi:role="line"\n           id="tspan3858"\n           x="59.530632"\n           y="77.325226"\n           style="font-size:16px;font-weight:bold;letter-spacing:-1.32000005px;fill:#000000;-inkscape-font-specification:Sans Bold">'+str('%02d' % self.counter)+'</tspan></text>\n      <path\n         style="opacity:0;fill:#000000;stroke:none;display:inline"\n         id="path3919"\n         inkscape:connector-curvature="0"\n         d="m 60,72 4,-4 4,4 8,-8 4,4 -12,12 -8,-8 z" />\n      <path\n         style="opacity:0.6;color:#000000;fill:url(#linearGradient3948);fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:2;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate"\n         id="path3933"\n         inkscape:connector-curvature="0"\n         d="M 71.5625,52 68.71875,55.34375 65.3125,52.5625 63.78125,56.65625 59.625,55.1875 l 0,1 4.15625,1.46875 1.53125,-4.09375 3.40625,2.78125 L 71.5625,53 73.8125,56.78125 77.625,54.625 78.4375,58.9375 82.625,58.25 82.78125,57.21875 78.4375,57.9375 77.625,53.625 73.8125,55.78125 71.5625,52 z m -11.96875,7.59375 -4.40625,0.03125 0.34375,1 4.0625,-0.03125 0,-1 z m 22.625,2 -0.15625,0.96875 3.8125,0.71875 0.5,-0.90625 -4.15625,-0.78125 z m -25.875,2.3125 -3.78125,1.40625 0.625,0.78125 3.46875,-1.3125 -0.3125,-0.875 z m 28.3125,2.53125 -0.4375,0.75 3.09375,1.84375 L 88,68.4375 l -3.34375,-2 z M 54.875,69.125 52,71.5625 l 0.6875,0.40625 2.65625,-2.25 L 54.875,69.125 z m 30.25,2.75 -0.46875,0.40625 2.15625,2.625 0.625,-0.21875 -2.3125,-2.8125 z m -29.78125,2.6875 -1.71875,3.0625 0.5,0.09375 1.65625,-2.90625 -0.4375,-0.25 z m 28.3125,2.53125 -0.3125,0.125 1.125,3.15625 0.34375,0 -1.15625,-3.28125 z m -25.875,2.3125 -0.5625,3.375 L 57.375,82.75 57.9375,79.4375 57.78125,79.40625 z" />\n      <text\n         xml:space="preserve"\n         style="font-size:12px;font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;text-align:start;line-height:125%;writing-mode:lr-tb;text-anchor:start;opacity:0.3;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;font-family:Sans;-inkscape-font-specification:Sans Bold"\n         x="60.261475"\n         y="76.597481"\n         id="text3074"\n         sodipodi:linespacing="125%"><tspan\n           sodipodi:role="line"\n           id="tspan3076"\n           x="60.261475"\n           y="76.597481"\n           style="font-size:14px;fill:#000000">'+str('%02d' % self.counter)+'</tspan></text>\n      <text\n         transform="scale(0.9999961,1.0000039)"\n         sodipodi:linespacing="125%"\n         id="text3852"\n         y="78.053253"\n         x="58.71452"\n         style="font-size:18px;font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;text-align:start;line-height:125%;letter-spacing:-1.32000005px;writing-mode:lr-tb;text-anchor:start;opacity:0.05;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;font-family:Sans;-inkscape-font-specification:Sans Bold"\n         xml:space="preserve"><tspan\n           style="font-size:18px;font-weight:bold;letter-spacing:-2.47000003px;fill:#000000;-inkscape-font-specification:Sans Bold"\n           y="78.053253"\n           x="58.71452"\n           id="tspan3854"\n           sodipodi:role="line">'+str('%02d' % self.counter)+'</tspan></text>\n      <text\n         sodipodi:linespacing="125%"\n         id="text3070"\n         y="76.097481"\n         x="60.261475"\n         style="font-size:12px;font-style:normal;font-variant:normal;font-weight:bold;font-stretch:normal;text-align:start;line-height:125%;writing-mode:lr-tb;text-anchor:start;fill:#ff0000;fill-opacity:1;fill-rule:nonzero;stroke:none;font-family:Sans;-inkscape-font-specification:Sans Bold"\n         xml:space="preserve"><tspan\n           style="font-size:14px;fill:#ffffff"\n           y="76.097481"\n           x="60.261475"\n           id="tspan3072"\n           sodipodi:role="line">'+str('%02d' % self.counter)+'</tspan></text>\n    </g>\n  </g>\n</svg>\n'
				svg = open('emblem.svg', 'w')                    
				svg.write(self.svg_data)                    
				svg.close()
				# rest icon
				self.icon.SetIcon("~/.config/cairo-dock/third-party/Facebook/icon")
				# put svg emblem on icon
				self.icon.SetEmblem("~/.config/cairo-dock/third-party/Facebook/emblem.svg", CDApplet.UPPER_RIGHT) 
	
	def check_when(self, diff):
		# this method checks whether the user needs attention or not
		att = self.appconfig["ATTENTION_WHEN"]
		if att == "always" and self.counter != 0:
			return True 
		elif att == "different" and diff != 0:
			return True
		elif att == "superior" and diff < 0:
			return True
		else:
			return False
			
	def attention(self):
		# this method fetches user options from appconfig dictionary
		how = self.appconfig["ATTENTION_HOW"]
		dia = self.appconfig["ATTENTION_DIA"]
		sound = self.appconfig["ATTENTION_SOUND"]
		# then it acts accordingly
		if how == "none":
			pass
		else:
			# self.icon.DemandsAttention(True, how) ## NEED TO FIND OUT HOW TO STOP THIS NEATLY
			self.icon.DemandsAttention(True, how)
		if dia == True:
			# checking our grammar ;)
			if self.counter > 1:
				s = 's'
			else:
				s = ''
			self.icon.ShowDialog("You have "+str(self.counter)+" notification%s on your Facebook Account" % s,3)
		else:
			pass
		if sound == True:
			os.popen('aplay ~/.config/cairo-dock/third-party/Facebook/alarm.wav')
		else:
			pass
		self.icon.DemandsAttention(False, 'how')
		
	def consider(self):
		# this method will check whether the user should be alarmed
		new_counter = 0
		# it finds out what notifications the user wants ...
		for i in self.fbconfig:
			# ... by omitting those with a value = False
			if self.fbconfig[i] == False:
				pass
			else:
				# then we count the values of each desired nofitication
				# since fbconfig and fb cleverly have the same keys [i] it's a piece of cake!
				new_counter += self.fb[i]
		# it records difference between the current and the prior counter
		diff = self.counter - new_counter
		# it updates the applet's counter
		self.counter = new_counter
		# it requests the quickinfo on the icon:
		self.set_quick_info()
		# it checks whether the user wants to be informed about the new counter value
		need = self.check_when(diff)
		# if indeed the user wants to be informed, the method requests this signal
		if need == True:
			self.attention()
		else:
			pass
		# that's it: now the applet waits for the next update :) 
		
	def error(self):
		#signal the applet is in difficulty by adding a [!] emblem to the icon:
		# reset icon:
		self.icon.SetIcon("~/.config/cairo-dock/third-party/Facebook/icon")
		# put warning svg emblem on icon
		self.icon.SetEmblem("~/.config/cairo-dock/third-party/Facebook/warning.svg", CDApplet.UPPER_RIGHT)
		
	def read_fb(self):
		# reset fblist
		print "reading facebook"
		fblist = []
		# this method fetches information from FaceBook with fbcmd
		# it runs the "fbcmd NOTIFY" command, returns and parses results in a "fblist" list
		result = subprocess.Popen(['fbcmd', 'NOTIFY'], stdout=PIPE).stdout
		fblist = result.readlines()
		print fblist
		# if there is no internet connection, the list will be empty
		if fblist != []:
			pass
		else:
			print '...Facebook Applet could not connect to the Internet. Trying later.'
			self.error()
			return False
		# then it omits friend request details and feeds the result into a the "self.fb" dictionary
		for i in fblist:
			ii = i.split()
			try:
				# the required lines end with an integer, but readlines() returns them as strings
				# by attempting to convert the last item of the line into an integer
				# we aslo sort out the junk (i.e. friend request details)
				number = int(ii[-1])
				self.fb[ii[0]] = number
			except:
				pass
		# next the method runs "fbcmd NOTICES unread", returns and parse results in self.fb
		# first fetch the data
		result = subprocess.Popen(['fbcmd', 'NOTICES', 'unread'], stdout=PIPE).stdout
		ls = result.readlines()
		# remove the header if any
		try:
			del ls[0]
			# then count the lines that start with "["
			count = 0
			for i in ls:
				if i[0] == '[':
					count += 1
				else:
					pass
			# finally bring the result in self.fb
			self.fb['NOTICES_UNREAD'] = count
		except:
			self.fb['NOTICES_UNREAD'] = 0
		return True
		
	def update(self):
		# this method updates the information from Facebook
		# but first it needs to know whether the cairo-dock process still exists
		master = self.findcairo()
		# test log
		print "...updating Facebook Applet"
		# now the process can fetch information from Facebook
		# since the findcairo() method should have terminated the program
		# in case cairo-dock does not exist, there is no need to check again
		# the update method continues asking read_fb() to fetch data from Facebook
		try_read = self.read_fb()
		if try_read == True:
			print try_read
			# then it checks whether there is any need to alarm the user
			self.consider()
		else:
			pass
		# returning master=True will tell the repeat method to continue
		return master
		
	def check_again(self):
		# this method will check the steps of installation till fbcmd_steps()
		# returns False
		glib.timeout_add(3000, self.fbcmd_steps)
		
	def begin(self):
		# this is a function inherited from the CDApplet class
		# it will run automatically as the CDApplet instance is initated
		# after the get_config() method:
		
		# check if fbcmd is installed:
		# the log file should already have provided info, otherwise:
		if self.fbcmd == False:
			# it checks if fbcmd's installed
			self.fbcmd = self.find_fbcmd()
			# if it doesn't suceed:
			if self.fbcmd == False:
				# it guides the user through installation
				self.dialog_type = 1
				self.check_again()
			else:
				pass
		# check if fbcmd has access to Facebook
		# the log file should already have provided info, otherwise:
		if self.fbcmdpass == False:
			# it checks whether fbcmd can get access to Facebook
			self.fbcmdpass = self.check_access()
			# if there seems to be no access:
			if self.fbcmdpass == False:
				# it guides the user through authorisation
				self.dialog_type = 2
				self.check_again()
			else:
				pass
			self.writetolog()
		# if there is both FBCMD and Access
		# and if we haven't gone through the installation steps before
		if self.fbcmd == True and self.fbcmdpass == True and self.dialog_type != 5:
			self.update()
			self.repeat()
		else:
			# if the two conditions are not True, then the steps start all over again
			# hopefully we don't need that since it should have been caught before :)
			self.dialog_type == 1
			self.check_again()
		
	def findcairo(self):
		# this method looks for an existing instance of the cairo-dock process
		# it will return True if the process exists
		# it will shut down the session if it cannot find cairo-dock
		try:
			net = os.popen("ps -C cairo-dock | grep cairo-dock").readlines()[0].split()
			return True
		except:
			# test log
			print "...Facebook Applet can't find cairo-dock...byebye!"
			sys.exit()
	
	def repeat(self):
		# this method repeats a callback (here the self.update method)
		# it will keep on repeating as long as the callback returns True
		glib.timeout_add(self.recurence, self.update)

# CALLBACKS #

	def on_click(self, iState):
		# when the user clicks on the icon, it opens the facebook page
		# more actions will be available in future versions
		subprocess.call([self.click], shell=True)
		
	def on_answer_dialog(self, key, content):
		# this listener works as a counterpart of fbcmd_steps()
		# waiting for user response to change the semaphore
		# response to dialogue 4 asking for authorisation code
		if self.dialog_type == 44:
			# if user cancelled operation
			if key == 1:
				# another chance is given to the user to type the access code
				self.dialog_type = 3
			else:
				self.access_fbcmd(content)
				# keeping the dialog_type == 44 will tell fbcmd_steps()
				# to continue iterating till the access is granted
		# response to dialogue 3 asking for fetch access code
		elif self.dialog_type == 33:
			## if user cancelled operation
			if key == 1:
				self.access_failed()
			else:
				subprocess.call(["x-www-browser 'http://www.facebook.com/code_gen.php?v=1.0&api_key=42463270450'"], shell=True)
				# dialog_type = 4 will send fbcmd_steps() method to next step
				self.dialog_type = 4
		# response to dialogue 2 asking for grant authorisation to applet
		elif self.dialog_type == 22:
			## if user cancelled operation
			if key == 1:
				self.access_failed()
			else:
				subprocess.call(["x-www-browser 'https://www.facebook.com/dialog/oauth?client_id=42463270450&redirect_uri=http://www.facebook.com/connect/login_success.html'"], shell=True)
				# dialog_type = 3 will send fbcmd_steps() method to next step
				self.dialog_type = 3
		# response to dialgoue 1 requesting installation
		elif self.dialog_type == 11:
			if key == 0:
				print "answer is yes"
				# the dialog_type is not reset till installation is complete
				# to prevent other dialogues to stand in the way
				# while type == 11, fbcmd_steps() will keep iterating
				self.install_fbcmd()
			else:
				self.install_failed()
		else:
			#no need to respond to notifications
			pass

if __name__ == '__main__':
	facebook = FaceBook()
	facebook.begin()
	gtk.main()

